name: ğŸš€ FluxStack v1.4.0 - Complete Build & Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

env:
  BUN_VERSION: '1.1.34'
  NODE_VERSION: '20'

jobs:
  # ğŸ“¦ Test unified dependency installation
  installation-test:
    name: ğŸ“¦ Monorepo Installation Test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“Š Test installation performance
        run: |
          echo "â±ï¸ Testing monorepo unified installation..."
          time_start=$(date +%s)
          bun install
          time_end=$(date +%s)
          duration=$((time_end - time_start))
          echo "âœ… Installation completed in ${duration}s"
          
          # Verify single node_modules
          if [ -d "node_modules" ] && [ ! -d "app/client/node_modules" ]; then
            echo "âœ… Unified node_modules structure confirmed"
          else
            echo "âŒ Monorepo structure validation failed"
            exit 1
          fi

      - name: ğŸ“‹ Verify dependencies availability
        run: |
          echo "ğŸ” Checking if libraries are available for both frontend and backend..."
          
          # Check React (frontend)
          if bun pm ls | grep -q "react@"; then
            echo "âœ… React available for frontend"
          else
            echo "âŒ React missing"
            exit 1
          fi
          
          # Check Elysia (backend)
          if bun pm ls | grep -q "elysia@"; then
            echo "âœ… Elysia available for backend"
          else
            echo "âŒ Elysia missing"  
            exit 1
          fi
          
          # Check shared dependencies
          if bun pm ls | grep -q "typescript@"; then
            echo "âœ… TypeScript available for both"
          else
            echo "âŒ TypeScript missing"
            exit 1
          fi

  # ğŸ§ª Run all 30 tests
  test-suite:
    name: ğŸ§ª Complete Test Suite (30 Tests)
    runs-on: ubuntu-latest
    needs: installation-test
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ§ª Run all tests
        run: |
          echo "ğŸ”¬ Running complete test suite..."
          bun run test

      - name: ğŸ“Š Generate test coverage
        run: |
          echo "ğŸ“ˆ Generating test coverage report..."
          bun run test:coverage

      - name: ğŸ“‹ Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          fail_ci_if_error: false

  # ğŸ¨ Frontend build isolation test
  frontend-build-test:
    name: ğŸ¨ Frontend Build Isolation
    runs-on: ubuntu-latest
    needs: installation-test
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ¨ Build frontend only
        run: |
          echo "ğŸ—ï¸ Testing isolated frontend build..."
          bun run build:frontend

      - name: âœ… Verify frontend build artifacts
        run: |
          echo "ğŸ” Checking frontend build output..."
          
          if [ -d "dist/client" ]; then
            echo "âœ… Frontend dist directory created"
          else
            echo "âŒ Frontend dist directory missing"
            exit 1
          fi
          
          if [ -f "dist/client/index.html" ]; then
            echo "âœ… Frontend index.html generated"
          else
            echo "âŒ Frontend index.html missing"
            exit 1
          fi
          
          if [ -d "dist/client/assets" ]; then
            echo "âœ… Frontend assets directory created"
            echo "ğŸ“‹ Assets found:"
            ls -la dist/client/assets/
          else
            echo "âŒ Frontend assets directory missing"
            exit 1
          fi

      - name: ğŸ“ Check bundle size
        run: |
          echo "ğŸ“Š Frontend bundle analysis:"
          du -sh dist/client/
          echo "ğŸ“‹ Asset breakdown:"
          find dist/client/assets -name "*.js" -exec ls -lh {} \;
          find dist/client/assets -name "*.css" -exec ls -lh {} \;

  # âš¡ Backend build isolation test
  backend-build-test:
    name: âš¡ Backend Build Isolation  
    runs-on: ubuntu-latest
    needs: installation-test
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: âš¡ Build backend only
        run: |
          echo "ğŸ—ï¸ Testing isolated backend build..."
          bun run build:backend

      - name: âœ… Verify backend build artifacts
        run: |
          echo "ğŸ” Checking backend build output..."
          
          if [ -f "dist/index.js" ]; then
            echo "âœ… Backend bundle created"
            ls -lh dist/index.js
          else
            echo "âŒ Backend bundle missing"
            exit 1
          fi

      - name: ğŸ§ª Test backend bundle execution
        run: |
          echo "ğŸš€ Testing backend bundle execution..."
          timeout 10s bun dist/index.js || true
          echo "âœ… Backend bundle executable"

  # ğŸš€ Full-stack unified build test  
  fullstack-build-test:
    name: ğŸš€ Full-Stack Unified Build
    runs-on: ubuntu-latest
    needs: installation-test
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ—ï¸ Full unified build
        run: |
          echo "ğŸ”§ Testing unified full-stack build..."
          bun run build

      - name: âœ… Verify complete build artifacts
        run: |
          echo "ğŸ” Checking complete build output..."
          
          # Check frontend artifacts
          if [ -d "dist/client" ] && [ -f "dist/client/index.html" ]; then
            echo "âœ… Frontend build completed"
          else
            echo "âŒ Frontend build incomplete"
            exit 1
          fi
          
          # Check backend artifacts  
          if [ -f "dist/index.js" ]; then
            echo "âœ… Backend build completed"
          else
            echo "âŒ Backend build incomplete"
            exit 1
          fi
          
          echo "ğŸ“Š Complete build size:"
          du -sh dist/

      - name: ğŸš€ Test production server simulation
        run: |
          echo "ğŸŒ Testing production server startup..."
          timeout 15s bun run start &
          sleep 5
          
          # Test API endpoint
          if curl -f http://localhost:3000/api/health; then
            echo "âœ… Production server API responding"
          else
            echo "âŒ Production server API not responding"
            exit 1
          fi

  # ğŸ”§ Development mode tests
  development-mode-test:
    name: ğŸ”§ Development Modes Test
    runs-on: ubuntu-latest  
    needs: installation-test
    strategy:
      matrix:
        mode: [frontend, backend]
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ”§ Test ${{ matrix.mode }} development mode
        run: |
          echo "ğŸš€ Testing ${{ matrix.mode }} development mode..."
          
          if [ "${{ matrix.mode }}" == "frontend" ]; then
            timeout 30s bun run dev:frontend &
            sleep 10
            if curl -f http://localhost:5173; then
              echo "âœ… Frontend dev server responding"
            else
              echo "âŒ Frontend dev server not responding"
              exit 1
            fi
          fi
          
          if [ "${{ matrix.mode }}" == "backend" ]; then
            timeout 30s bun run dev:backend &  
            sleep 10
            if curl -f http://localhost:3001/api/health; then
              echo "âœ… Backend dev server responding"
            else
              echo "âŒ Backend dev server not responding"  
              exit 1
            fi
          fi

  # ğŸ³ Docker build tests
  docker-build-test:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    needs: [frontend-build-test, backend-build-test]
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image
        run: |
          echo "ğŸ³ Building FluxStack Docker image..."
          docker build -t fluxstack:test .

      - name: ğŸ§ª Test Docker container
        run: |
          echo "ğŸš€ Testing Docker container..."
          docker run -d -p 3000:3000 --name fluxstack-test fluxstack:test
          sleep 10
          
          if curl -f http://localhost:3000/api/health; then
            echo "âœ… Docker container API responding"
          else
            echo "âŒ Docker container API not responding"
            exit 1
          fi
          
          docker stop fluxstack-test

  # ğŸ”„ Hot reload simulation test
  hot-reload-test:
    name: ğŸ”„ Hot Reload Independence Test
    runs-on: ubuntu-latest
    needs: installation-test  
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ”¥ Test hot reload independence
        run: |
          echo "ğŸ”„ Testing hot reload independence..."
          
          # Start full-stack dev mode
          timeout 60s bun run dev &
          DEV_PID=$!
          sleep 15
          
          # Verify both servers are running
          if curl -f http://localhost:3000/api/health && curl -f http://localhost:5173; then
            echo "âœ… Both frontend and backend started successfully"
          else
            echo "âŒ Development servers failed to start"
            kill $DEV_PID 2>/dev/null || true
            exit 1
          fi
          
          kill $DEV_PID 2>/dev/null || true

  # ğŸ“Š Performance benchmarks
  performance-test:
    name: ğŸ“Š Performance Benchmarks
    runs-on: ubuntu-latest
    needs: installation-test
    steps:
      - name: ğŸ“¥ Checkout repository  
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: â±ï¸ Benchmark installation speed
        run: |
          echo "âš¡ Benchmarking installation performance..."
          rm -rf node_modules bun.lockb
          
          time_start=$(date +%s%3N)
          bun install
          time_end=$(date +%s%3N)  
          duration=$((time_end - time_start))
          
          echo "ğŸ“Š Installation completed in ${duration}ms"
          echo "ğŸ¯ Target: <15000ms (15s)"
          
          if [ $duration -lt 15000 ]; then
            echo "âœ… Installation performance acceptable"
          else
            echo "âš ï¸ Installation slower than expected"
          fi

      - name: â±ï¸ Benchmark build performance  
        run: |
          echo "ğŸ—ï¸ Benchmarking build performance..."
          
          # Frontend build benchmark
          time_start=$(date +%s%3N)
          bun run build:frontend
          time_end=$(date +%s%3N)
          frontend_duration=$((time_end - time_start))
          echo "ğŸ¨ Frontend build: ${frontend_duration}ms"
          
          # Backend build benchmark  
          time_start=$(date +%s%3N)
          bun run build:backend
          time_end=$(date +%s%3N)
          backend_duration=$((time_end - time_start))
          echo "âš¡ Backend build: ${backend_duration}ms"
          
          # Total unified build
          time_start=$(date +%s%3N)
          bun run build
          time_end=$(date +%s%3N)
          total_duration=$((time_end - time_start))
          echo "ğŸš€ Total build: ${total_duration}ms"

  # âœ… Summary job
  build-summary:
    name: âœ… Build Test Summary
    runs-on: ubuntu-latest
    needs: [
      installation-test, 
      test-suite,
      frontend-build-test, 
      backend-build-test, 
      fullstack-build-test,
      development-mode-test,
      docker-build-test,
      hot-reload-test,
      performance-test
    ]
    if: always()
    steps:
      - name: ğŸ“‹ Build Summary
        run: |
          echo "ğŸ‰ FluxStack v1.4.0 Build Test Summary"
          echo "=================================="
          echo "âœ… Monorepo installation: ${{ needs.installation-test.result }}"
          echo "âœ… Complete test suite (30 tests): ${{ needs.test-suite.result }}"  
          echo "âœ… Frontend build isolation: ${{ needs.frontend-build-test.result }}"
          echo "âœ… Backend build isolation: ${{ needs.backend-build-test.result }}"
          echo "âœ… Full-stack unified build: ${{ needs.fullstack-build-test.result }}"
          echo "âœ… Development modes: ${{ needs.development-mode-test.result }}"
          echo "âœ… Docker containerization: ${{ needs.docker-build-test.result }}"
          echo "âœ… Hot reload independence: ${{ needs.hot-reload-test.result }}"
          echo "âœ… Performance benchmarks: ${{ needs.performance-test.result }}"
          echo ""
          echo "ğŸš€ FluxStack v1.4.0 monorepo architecture validated!"

      - name: âŒ Fail if any test failed
        if: |
          needs.installation-test.result == 'failure' ||
          needs.test-suite.result == 'failure' ||
          needs.frontend-build-test.result == 'failure' || 
          needs.backend-build-test.result == 'failure' ||
          needs.fullstack-build-test.result == 'failure' ||
          needs.development-mode-test.result == 'failure' ||
          needs.docker-build-test.result == 'failure' ||
          needs.hot-reload-test.result == 'failure' ||
          needs.performance-test.result == 'failure'
        run: |
          echo "âŒ Some tests failed - check individual job results"
          exit 1