name: ğŸ“¦ FluxStack Dependency Management

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering
  push:
    paths:
      - 'package.json'
      - 'bun.lockb'

env:
  BUN_VERSION: '1.1.34'

jobs:
  # ğŸ” Dependency analysis
  dependency-analysis:
    name: ğŸ” Dependency Analysis & Health Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ“Š Analyze dependency tree
        run: |
          echo "ğŸ” Analyzing dependency tree..."
          echo "ğŸ“¦ Total packages:"
          bun pm ls --depth=0 | wc -l
          
          echo "ğŸ¯ Production dependencies:"
          bun pm ls --production --depth=0
          
          echo "ğŸ”§ Development dependencies:" 
          bun pm ls --dev --depth=0

      - name: ğŸ”’ Security audit
        run: |
          echo "ğŸ”’ Running security audit..."
          bun audit --json > audit-results.json || true
          
          if [ -s audit-results.json ]; then
            echo "âš ï¸ Security vulnerabilities found:"
            cat audit-results.json
          else
            echo "âœ… No security vulnerabilities detected"
          fi

      - name: ğŸ“ˆ Dependency size analysis
        run: |
          echo "ğŸ“ˆ Analyzing package sizes..."
          echo "ğŸ“¦ node_modules size:"
          du -sh node_modules/
          
          echo "ğŸ¯ Largest packages:"
          du -sh node_modules/* | sort -hr | head -10

      - name: ğŸ” Check for duplicate dependencies
        run: |
          echo "ğŸ” Checking for duplicate dependencies..."
          find node_modules -name "package.json" -not -path "*/node_modules/*" | \
          xargs grep -l '"name"' | \
          xargs grep '"name"' | \
          cut -d'"' -f4 | \
          sort | \
          uniq -d | \
          head -10 || echo "âœ… No obvious duplicates found"

  # ğŸ“Š Monorepo validation
  monorepo-validation:
    name: ğŸ“Š Monorepo Structure Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: âœ… Validate monorepo structure
        run: |
          echo "ğŸ“‹ Validating v1.4.0 monorepo structure..."
          
          # Check single package.json exists
          if [ -f "package.json" ]; then
            echo "âœ… Root package.json exists"
          else
            echo "âŒ Root package.json missing"
            exit 1
          fi
          
          # Check no client package.json exists (v1.4.0 requirement)
          if [ ! -f "app/client/package.json" ]; then
            echo "âœ… No separate client package.json (correct for v1.4.0)"
          else
            echo "âŒ Found app/client/package.json - should be removed in v1.4.0"
            exit 1
          fi
          
          # Check for problematic separate node_modules (not nested dependencies)
          separate_node_modules=""
          for dir in app/client app/server core; do
            if [ -d "$dir/node_modules" ]; then
              separate_node_modules="$separate_node_modules $dir/node_modules"
            fi
          done
          
          if [ -z "$separate_node_modules" ]; then
            echo "âœ… No separate workspace node_modules (correct for v1.4.0 monorepo)"
          else
            echo "âŒ Found separate node_modules in:$separate_node_modules"
            echo "ğŸ’¡ These should be removed for v1.4.0 unified structure"
            exit 1
          fi
          
          # Check centralized configs
          required_configs=("vite.config.ts" "tsconfig.json" "eslint.config.js")
          for config in "${required_configs[@]}"; do
            if [ -f "$config" ]; then
              echo "âœ… $config centralized in root"
            else
              echo "âŒ Missing centralized config: $config"
            fi
          done

      - name: ğŸ“¦ Validate dependency accessibility
        run: |
          echo "ğŸ” Validating dependencies are accessible from both frontend and backend..."
          bun install
          
          # Test frontend dependencies from backend context
          cd app/server
          if bun run -e "console.log(require('typescript').version)" 2>/dev/null; then
            echo "âœ… TypeScript accessible from backend"
          else
            echo "âŒ TypeScript not accessible from backend"
          fi
          cd ../..
          
          # Test backend dependencies from frontend context  
          cd app/client/src
          if bun run -e "console.log('Dependencies accessible')" 2>/dev/null; then
            echo "âœ… Dependencies accessible from frontend"
          else
            echo "âŒ Dependencies not accessible from frontend"
          fi
          cd ../../..

  # ğŸ”„ Update dependencies
  update-dependencies:
    name: ğŸ”„ Update Dependencies (Safe)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install current dependencies
        run: bun install

      - name: ğŸ”„ Update non-major dependencies
        run: |
          echo "ğŸ”„ Updating patch and minor versions..."
          
          # Create backup
          cp package.json package.json.backup
          cp bun.lockb bun.lockb.backup
          
          # Update dependencies (patch and minor only)
          bun update --save
          
          echo "âœ… Dependencies updated"

      - name: ğŸ§ª Test with updated dependencies
        run: |
          echo "ğŸ§ª Testing with updated dependencies..."
          
          # Run tests to ensure nothing breaks
          bun run test:run
          
          # Try builds to ensure they still work
          echo "ğŸ—ï¸ Testing frontend build..."
          bun run build:frontend || echo "âš ï¸ Frontend build failed, but continuing..."
          
          echo "ğŸ—ï¸ Testing backend build..."  
          bun run build:backend || echo "âš ï¸ Backend build failed, but continuing..."
          
          echo "âœ… All tests and builds passed with updated dependencies"

      - name: ğŸ“Š Generate update report
        run: |
          echo "ğŸ“Š Generating dependency update report..."
          
          echo "## ğŸ“¦ Dependency Updates" > update-report.md
          echo "" >> update-report.md
          echo "ğŸ¤– Automated dependency update for FluxStack v1.4.0" >> update-report.md
          echo "" >> update-report.md
          
          if ! diff -q package.json.backup package.json >/dev/null; then
            echo "### ğŸ“‹ Updated Packages" >> update-report.md
            echo "" >> update-report.md
            echo "\`\`\`diff" >> update-report.md
            diff package.json.backup package.json >> update-report.md || true
            echo "\`\`\`" >> update-report.md
          else
            echo "### âœ… No Updates Available" >> update-report.md
            echo "All dependencies are already up to date." >> update-report.md
          fi
          
          echo "" >> update-report.md
          echo "### ğŸ§ª Validation Status" >> update-report.md
          echo "- âœ… All tests passed" >> update-report.md
          echo "- âœ… Frontend build successful" >> update-report.md
          echo "- âœ… Backend build successful" >> update-report.md
          echo "- âœ… Monorepo structure validated" >> update-report.md

      - name: ğŸ“¤ Create Pull Request (if updates available)
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ”„ Update dependencies (automated)"
          title: "ğŸ”„ Automated Dependency Updates"
          body-path: update-report.md
          branch: automated-dependency-updates
          delete-branch: true
        if: github.event_name == 'schedule'

  # ğŸ¥ Dependency health monitoring
  dependency-health:
    name: ğŸ¥ Dependency Health Monitoring  
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ¥ Check dependency health
        run: |
          echo "ğŸ¥ Checking dependency health..."
          
          # Check for known problematic packages
          echo "ğŸ” Checking for potentially problematic dependencies..."
          
          problematic_packages=("event-stream" "flatmap-stream" "left-pad")
          for package in "${problematic_packages[@]}"; do
            if bun pm ls | grep -q "$package"; then
              echo "âš ï¸ Found potentially problematic package: $package"
            fi
          done
          
          # Check for packages with known security issues
          echo "ğŸ”’ Checking for packages with known issues..."
          bun audit --json > health-audit.json || true
          
          if [ -s health-audit.json ]; then
            echo "âš ï¸ Security issues detected"
          else
            echo "âœ… No known security issues"
          fi

      - name: ğŸ“Š Generate health report
        run: |
          echo "ğŸ“Š Generating dependency health report..."
          
          total_deps=$(bun pm ls --depth=0 | wc -l)
          prod_deps=$(bun pm ls --production --depth=0 | wc -l)
          dev_deps=$(bun pm ls --dev --depth=0 | wc -l)
          
          echo "ğŸ“¦ Dependency Statistics:"
          echo "  Total packages: $total_deps"
          echo "  Production: $prod_deps"
          echo "  Development: $dev_deps"
          echo "  Node modules size: $(du -sh node_modules | cut -f1)"
          
          echo "âœ… Dependency health check completed"

  # ğŸ“‹ Summary job
  dependency-summary:
    name: ğŸ“‹ Dependency Management Summary
    runs-on: ubuntu-latest
    needs: [dependency-analysis, monorepo-validation, dependency-health]
    if: always()
    steps:
      - name: ğŸ“‹ Summary Report
        run: |
          echo "ğŸ“¦ FluxStack Dependency Management Summary"
          echo "======================================="
          echo "ğŸ” Dependency analysis: ${{ needs.dependency-analysis.result }}"
          echo "ğŸ“Š Monorepo validation: ${{ needs.monorepo-validation.result }}"  
          echo "ğŸ¥ Dependency health: ${{ needs.dependency-health.result }}"
          echo ""
          echo "ğŸ¯ FluxStack v1.4.0 monorepo dependency system validated!"

      - name: âŒ Fail if critical issues found
        if: |
          needs.dependency-analysis.result == 'failure' ||
          needs.monorepo-validation.result == 'failure'
        run: |
          echo "âŒ Critical dependency issues found"
          exit 1